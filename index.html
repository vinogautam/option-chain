<!doctype html>
<html class="no-js">
  <head>
    <meta charset="utf-8">
    <title>Option Chain</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" />
	  <style>
		  th::nth-child(3), td::nth-child(3){
			  //display: none;
		  }
		  th{text-align:center}td{position:relative;padding-right:30px;}
		  td.first:after {
    content: '1';
    background: #fff;
    width: 15px;
    height: 15px;
    border-radius: 50px;
    display: inline-block;
    position: absolute;
    right: 10px;
			  border:1px solid;
}td.second:after {
    content: '2';
    background: #fff;
    width: 15px;
    height: 15px;
    border-radius: 50px;
    display: inline-block;
    position: absolute;
    right: 10px;border:1px solid;
}
		  td.third:after {
    content: '3';
    background: #fff;
    width: 15px;
    height: 15px;
    border-radius: 50px;
    display: inline-block;
    position: absolute;
    right: 10px;border:1px solid;
}
		#data-container tr.ceachieved td:nth-child(-n+4) {
		    background: #f31141;   
		}
		 #data-container tr.peachieved td:nth-child(n+6) {
		    background: green;   
		}
		  #data-container tr td:nth-child(-n+4) {
		    background: #efadad;   
		}
		 #data-container tr td:nth-child(n+6) {
		    background: lightgreen;   
		}
	  </style>
  </head>
  <body ng-app="yapp">
    <div class="row">
	    
	    <div class="col-md-6">
		    
		    
		    
		    <!-- TradingView Widget BEGIN -->
<!--<iframe style="width:100%" src="https://in.investing.com/charts/advinion.php?pair_ID=17950&domain_ID=56&lang_ID=56&timezone_ID=23&refresh=16&interval=16&version=6.3.1.0&userId=0&site=in.investing.com" height="420"></iframe>-->
		    <div id="canvas"></div>
	    </div>
	    <div id="msg-container" class="col-md-6">
		    
	    	<table style="width:100%;text-align:center;" cellspacing="0" border="1">
          <thead>
		  <tr>
			  <th colspan="4">Call</th><th style="background:grey">&nbsp;&nbsp;</th><th  colspan="4">Put</th>
		  </tr>
            <tr>
              <th>OI</th>    
              <th>Changing OI</th>
              <th>Volume</th>
              <th>LTP</th>
              <th style="background:grey">Strike Price</th>
              <th>LTP</th>
              <th>Volume</th>
              <th>Changing OI</th>
              <th>OI</th>
            </tr>
          </thead>
          <tbody id="data-container">
            
          </tbody>
	<tfoot>
		<tr>
			<th colspan="4"><span id="ceoi"></span></th><th style="background:grey">&nbsp;&nbsp;</th><th  colspan="4"><span id="peoi"></span></th>
		  </tr>
	</tfoot>
        </table>
		    <div class="text-center" >
			    <span id="ts"></span> <span id="ago"></span>
		    </div>
	    </div>
    </div>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.5.0/Chart.min.js"></script>  
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.5.8/firebase.js"></script>
    <script>
      // Initialize Firebase
       
// 		var firebaseConfig = {
// 			apiKey: "AIzaSyB4-JOBHODcDtIATqVDo1bzi_7vil54VP4",
// 			authDomain: "ismf3-84942.firebaseapp.com",
// 			databaseURL: "https://ismf3-84942-default-rtdb.firebaseio.com/",
// 			projectId: "ismf3-84942",
// 			storageBucket: "ismf3-84942.appspot.com",
// 			messagingSenderId: "1046598300596",
// 			appId: "1:1046598300596:web:908d03f47e987a6fcab8e1",
// 			measurementId: "G-ELCS2WLD33"
// 		  };
//       firebase.initializeApp(firebaseConfig);
	    
    </script>
	  <script type="module">
  // Import the functions you need from the SDKs you need
  //import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.6/firebase-app.js";
  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries

  // Your web app's Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyDKG2g_JD6iFH0qgTeOzCGdEZprHdL1B3c",
    authDomain: "ism-chat-ea48a.firebaseapp.com",
	databaseURL: "https://ism-chat-ea48a-default-rtdb.firebaseio.com/",
    projectId: "ism-chat-ea48a",
    storageBucket: "ism-chat-ea48a.appspot.com",
    messagingSenderId: "902636413859",
    appId: "1:902636413859:web:2496478a858c50b9adf016"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
	var db = firebase.database().ref('/ism-option-chain');
	$(document).ready(function(){
    db.on('value', function(s){
      var data = s.val();
      if (data) {
        var filterData = data.filtered.data.filter(a => (a.strikePrice > data.records.underlyingValue) ? ((a.strikePrice - data.records.underlyingValue) < 1500) : ((data.records.underlyingValue - a.strikePrice) < 1500));
        $("#data-container").empty();

        filterData.forEach(a => {
		var ceAchievedPrice = a.strikePrice < data.records.underlyingValue ? 'ceachieved' : '';
		var peAchievedPrice = a.strikePrice > data.records.underlyingValue ? 'peachieved' : '';
          $("#data-container").append('<tr class="'+ceAchievedPrice+ ' '+peAchievedPrice+'"><td>'+a.CE.openInterest+'</td><td>'+parseInt(a.CE.changeinOpenInterest)+'</td><td>'+a.CE.totalTradedVolume+'</td><td>'+a.CE.lastPrice+'</td><td style="background:grey">'+a.strikePrice+'</td><td>'+a.PE.lastPrice+'</td><td>'+a.PE.totalTradedVolume+'</td><td>'+parseInt(a.PE.changeinOpenInterest)+'</td><td>'+a.PE.openInterest+'</td></tr>')
        });

	$("#ceoi").text(data.filtered.CE.totOI);
	$("#peoi").text(data.filtered.PE.totOI);
	      
	      $("#ts").text(data.records.timestamp);
	      
	renderFirstSecond(filterData.map(a => parseInt(a.CE.openInterest)), 0);
      	renderFirstSecond(filterData.map(a => parseInt(a.CE.changeinOpenInterest)), 1);
	      renderFirstSecond(filterData.map(a => parseInt(a.CE.totalTradedVolume)), 2);
	      renderFirstSecond(filterData.map(a => parseInt(a.PE.totalTradedVolume)), 6);
	      renderFirstSecond(filterData.map(a => parseInt(a.PE.changeinOpenInterest)), 7);
	      renderFirstSecond(filterData.map(a => parseInt(a.PE.openInterest)), 8);
	      
	     firebase.database().ref('/ism-option-chain-oi').once('value', function(ss){
		     var data2 = ss.val();
      			if (data2) {
				$("#canvas").empty();
			     $("#canvas").append('<canvas id="myChart"></canvas>');
			     drawChart(data2);
			}
		     
	     }); 
	      
      }
    });
  });
		  
		  function renderFirstSecond(ceoi, ind){
		      var cefm = ceoi.indexOf(Math.max(...ceoi));
		      ceoi.splice(cefm,1,0);
		      var cesm = ceoi.indexOf(Math.max(...ceoi));
			ceoi.splice(cesm,1,0);
		      var cetm = ceoi.indexOf(Math.max(...ceoi));

		      $("#data-container tr:eq("+cefm+") td:eq("+ind+")").addClass('first');
		      $("#data-container tr:eq("+cesm+") td:eq("+ind+")").addClass('second');
			  $("#data-container tr:eq("+cetm+") td:eq("+ind+")").addClass('third');
		  }
		  
		  function drawChart(data){
			  var xValues = data.CE.map((a,i) => i);

				new Chart("myChart", {
				  type: "line",
				  data: {
				    labels: xValues,
				    datasets: [{ 
				      data: data.CE,
				      borderColor: "red",
				      fill: false
				    }, { 
				      data: data.PE,
				      borderColor: "green",
				      fill: false
				    }]
				  },
				  options: {
				    legend: {display: false}
				  }
				});
		  }
		  
		  setInterval(function(){
			  if ($("#ts").text()) {
			  	var timeVal = Math.round((new Date().getTime() - new Date($("#ts").text()).getTime()) / 60000);
				  $("#ago").text('- '+timeVal+' mins ago');
			  }
		  }, 10000);
</script>
  </body>
</html>
